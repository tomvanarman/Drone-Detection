<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Drone detections (Leaflet + OSM dark)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- tiny helper for color scales -->
  <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }

    .panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      background: rgba(16,16,16,0.92);
      color: #fff;
      padding: 12px 12px 10px 12px;
      border-radius: 10px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      max-width: 320px;
    }
    .panel h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      letter-spacing: 0.2px;
    }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row label { font-size: 12px; opacity: 0.95; }
    .row select, .row input {
      background: rgba(255,255,255,0.06);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
      outline: none;
    }
    .row input[type="number"] { width: 92px; }
    .hint { font-size: 11px; opacity: 0.75; margin-top: 8px; line-height: 1.25; }

    .legend {
      position: absolute;
      right: 12px;
      top: 12px;
      z-index: 1000;
      background: rgba(16,16,16,0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      min-width: 160px;
    }
    .legend h4 { margin: 0 0 8px 0; font-size: 13px; }
    .swatch-row { display:flex; align-items:center; gap:8px; margin: 4px 0; font-size: 12px; }
    .swatch { width: 12px; height: 12px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.25); }
    .bar {
      height: 10px;
      border-radius: 6px;
      background: linear-gradient(90deg, #2c7bb6, #abd9e9, #ffffbf, #fdae61, #d7191c);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .bar-labels {
      display:flex; justify-content:space-between; font-size: 11px; opacity: 0.85; margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Drone detections — point map</h3>
    <div class="row" style="margin-bottom:8px;">
      <label for="colorBy">Color by</label>
      <select id="colorBy">
        <option value="drone_type" selected>Drone type</option>
        <option value="duration_s">Duration (s)</option>
        <option value="max_altitude_m">Max altitude (m)</option>
      </select>
    </div>

    <div class="row" style="margin-bottom:6px;">
      <label>Filter duration (s)</label>
      <input id="minDur" type="number" step="1" placeholder="min" />
      <input id="maxDur" type="number" step="1" placeholder="max" />
    </div>

    <div class="row">
      <button id="resetBtn" style="cursor:pointer; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.08); color:#fff; padding:6px 10px; border-radius:8px; font-size:12px;">
        Reset view
      </button>
      <span id="count" style="font-size:12px; opacity:0.9;"></span>
    </div>

    <div class="hint">
      Put this HTML + the GeoJSON in the same GitHub Pages folder.<br/>
      The page loads <b>History_April_2024_points.geojson</b> via <code>fetch()</code>.
    </div>
  </div>

  <div class="legend" id="legend">
    <h4 id="legendTitle">Legend</h4>
    <div id="legendBody"></div>
  </div>

<script>
const GEOJSON_URL = "./History_April_2024_points.geojson";

const map = L.map("map", { zoomControl: true });

// Dark basemap (OSM data, CARTO tiles)
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
  maxZoom: 20,
  attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
}).addTo(map);

// Layer placeholder
let geoLayer = null;
let allFeatures = [];
let lastBounds = null;

function safeNum(x) {
  const n = Number(x);
  return Number.isFinite(n) ? n : null;
}

function uniq(arr) {
  return Array.from(new Set(arr.filter(v => v !== null && v !== undefined && v !== "")));
}

function buildTypePalette(types) {
  // stable palette from a fixed list (repeatable on reload)
  const base = chroma.scale(["#00c2ff","#7c4dff","#ff5c93","#2ee59d","#ffd166","#ff8a00","#a0ff72","#00d1b2","#f72585","#b5179e"]).colors(Math.max(3, types.length));
  const map = {};
  types.forEach((t,i)=> map[t] = base[i % base.length]);
  return map;
}

function getNumericDomain(features, prop) {
  let vals = features.map(f => safeNum(f.properties[prop])).filter(v => v !== null);
  if (!vals.length) return [0,1];
  vals.sort((a,b)=>a-b);
  // Robust domain (2%–98%) to avoid outliers wrecking the scale
  const lo = vals[Math.floor(vals.length * 0.02)];
  const hi = vals[Math.floor(vals.length * 0.98)];
  return [lo, hi];
}

function markerStyle(feature, colorBy, typePalette, numScale) {
  let color = "#00c2ff";
  if (colorBy === "drone_type") {
    color = typePalette[feature.properties.drone_type] || "#00c2ff";
  } else {
    const v = safeNum(feature.properties[colorBy]);
    color = (v === null) ? "#666" : numScale(v).hex();
  }
  return {
    radius: 4,
    color: color,
    fillColor: color,
    weight: 0,
    fillOpacity: 0.85
  };
}

function popupHtml(p) {
  const dur = (p.duration_s === null || p.duration_s === undefined) ? "—" : `${Math.round(p.duration_s)} s`;
  const alt = (p.max_altitude_m === null || p.max_altitude_m === undefined) ? "—" : `${Math.round(p.max_altitude_m)} m`;
  return `
    <div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; font-size:12px;">
      <div style="font-weight:700; margin-bottom:6px;">${p.drone_type || "Unknown drone"} </div>
      <div><b>Flight ID:</b> <span style="word-break:break-all;">${p.flight_id || "—"}</span></div>
      <div><b>Aeroscope ID:</b> ${p.aeroscope_id || "—"}</div>
      <div><b>Duration:</b> ${dur}</div>
      <div><b>Max altitude:</b> ${alt}</div>
      <div><b>Start:</b> ${p.start_time || "—"}</div>
      <div><b>End:</b> ${p.end_time || "—"}</div>
    </div>
  `;
}

function renderLegend(colorBy, features) {
  const titleEl = document.getElementById("legendTitle");
  const bodyEl = document.getElementById("legendBody");
  bodyEl.innerHTML = "";

  if (colorBy === "drone_type") {
    titleEl.textContent = "Drone type";
    const types = uniq(features.map(f => f.properties.drone_type)).sort();
    const palette = buildTypePalette(types);
    types.slice(0, 12).forEach(t => {
      const row = document.createElement("div");
      row.className = "swatch-row";
      row.innerHTML = `<div class="swatch" style="background:${palette[t]};"></div><div>${t}</div>`;
      bodyEl.appendChild(row);
    });
    if (types.length > 12) {
      const more = document.createElement("div");
      more.style.fontSize = "11px";
      more.style.opacity = "0.75";
      more.style.marginTop = "6px";
      more.textContent = `+ ${types.length - 12} more`;
      bodyEl.appendChild(more);
    }
    return palette;
  }

  // numeric legend
  titleEl.textContent = (colorBy === "duration_s") ? "Duration (s)" : "Max altitude (m)";
  const [lo, hi] = getNumericDomain(features, colorBy);
  const bar = document.createElement("div");
  bar.className = "bar";
  bodyEl.appendChild(bar);

  const labels = document.createElement("div");
  labels.className = "bar-labels";
  labels.innerHTML = `<span>${Math.round(lo)}</span><span>${Math.round(hi)}</span>`;
  bodyEl.appendChild(labels);

  return null;
}

function applyFiltersAndRedraw() {
  const colorBy = document.getElementById("colorBy").value;
  const minDur = safeNum(document.getElementById("minDur").value);
  const maxDur = safeNum(document.getElementById("maxDur").value);

  let filtered = allFeatures;
  if (minDur !== null) {
    filtered = filtered.filter(f => safeNum(f.properties.duration_s) !== null && safeNum(f.properties.duration_s) >= minDur);
  }
  if (maxDur !== null) {
    filtered = filtered.filter(f => safeNum(f.properties.duration_s) !== null && safeNum(f.properties.duration_s) <= maxDur);
  }

  document.getElementById("count").textContent = `${filtered.length.toLocaleString()} points`;

  // Setup color mapping
  let typePalette = {};
  let numScale = (v)=> chroma("#00c2ff");
  if (colorBy === "drone_type") {
    const types = uniq(filtered.map(f => f.properties.drone_type)).sort();
    typePalette = buildTypePalette(types);
  } else {
    const [lo, hi] = getNumericDomain(filtered, colorBy);
    numScale = chroma.scale(["#2c7bb6","#abd9e9","#ffffbf","#fdae61","#d7191c"]).domain([lo, hi]).clamp(true);
  }

  // Update legend & get palette for types (so legend matches the map)
  const legendPalette = renderLegend(colorBy, filtered);
  if (legendPalette) typePalette = legendPalette;

  // Remove old layer
  if (geoLayer) {
    geoLayer.remove();
  }

  geoLayer = L.geoJSON({ type:"FeatureCollection", features: filtered }, {
    pointToLayer: (feature, latlng) => {
      return L.circleMarker(latlng, markerStyle(feature, colorBy, typePalette, numScale));
    },
    onEachFeature: (feature, layer) => {
      layer.bindPopup(popupHtml(feature.properties), { maxWidth: 320 });
      layer.on("mouseover", () => layer.openPopup());
      layer.on("mouseout", () => layer.closePopup());
    }
  }).addTo(map);

  if (!lastBounds) {
    lastBounds = geoLayer.getBounds();
    map.fitBounds(lastBounds, { padding: [20, 20] });
  }
}

document.getElementById("colorBy").addEventListener("change", applyFiltersAndRedraw);
document.getElementById("minDur").addEventListener("input", applyFiltersAndRedraw);
document.getElementById("maxDur").addEventListener("input", applyFiltersAndRedraw);
document.getElementById("resetBtn").addEventListener("click", () => {
  if (lastBounds) map.fitBounds(lastBounds, { padding: [20, 20] });
});

fetch(GEOJSON_URL)
  .then(r => {
    if (!r.ok) throw new Error(`Failed to load ${GEOJSON_URL} (HTTP ${r.status})`);
    return r.json();
  })
  .then(gj => {
    allFeatures = gj.features || [];
    applyFiltersAndRedraw();
  })
  .catch(err => {
    console.error(err);
    alert(err.message + "\n\nTip: on GitHub Pages, both files must be in the same folder, and you must load the page over https (not file://).");
  });
</script>
</body>
</html>
